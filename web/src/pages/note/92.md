---
layout: ../../layouts/blog-post.astro
title: "bun:sqlite ã‚’ä½¿ã£ã¦ bun test ã§ Hono + Cloudflare Workers + D1 ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹"
emoji: ğŸ”¥
date: 2025-09-09T12:04:41Z
tags:
    - note
---

Cloudflare D1 ã‚’ `bun:sqlite` ã§ä»£ç”¨ã™ã‚‹ã“ã¨ã§ã€ wrangler ã‚’ä½¿ã‚ãšã« `bun test` ã§ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ã—ãŸã€‚ORM ã‚‚ä½¿ã£ã¦ã„ãªã„ã‚ˆã†ãªç°¡å˜ãªã‚¢ãƒ—ãƒªå‘ã‘ã€‚

ã¾ãšã€ `bun:sqlite` ã‚’ã‚ªãƒ³ãƒ¡ãƒ¢ãƒªã§ä½œæˆã—ã¦ã€å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”¨æ„ã—ã¤ã¤ D1 äº’æ›ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’è¿”ã™ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

```ts
import { Database } from 'bun:sqlite';

export function createMockD1Database() {
    const db = new Database(':memory:');

    db.exec('BEGIN');
    db.exec(`
        CREATE TABLE ...
    `);
    db.exec('COMMIT');

    return {
        prepare: (query: string) => {
            const stmt = db.prepare(query);

            return {
                bind: (...params: any[]) => ({
                    all: async () => {
                        try {
                            const results = stmt.all(...params);
                            return {
                                results,
                                success: true,
                                meta: {},
                            };
                        } catch (error: any) {
                            return {
                                results: [],
                                success: false,
                                meta: { error: error.message },
                            };
                        }
                    },
                    first: async () => {
                        try {
                            return stmt.get(...params) || null;
                        } catch (error) {
                            return null;
                        }
                    },
                    run: async () => {
                        try {
                            stmt.run(...params);
                            return {
                                success: true,
                                meta: {
                                    changes: db.changes,
                                    last_row_id: db.lastInsertRowid,
                                },
                            };
                        } catch (error: any) {
                            return {
                                success: false,
                                meta: { error: error.message },
                            };
                        }
                    },
                }),
            };
        },

        batch: async (statements: any[]) => {
            const results = [];
            for (const statement of statements) {
                const result = await statement.run();
                results.push(result);
            }
            return results;
        },

        exec: (sql: string) => {
            return db.exec(sql);
        },
    };
}
```

ã“ã®ãƒ¢ãƒƒã‚¯ã‚’ Hono ã® `testClient` ã§ `DB` ã¨ã—ã¦æ¸¡ã™ã“ã¨ã§ã€ D1 ã®ä»£ã‚ã‚Šã«ãƒ¢ãƒƒã‚¯ãŒä½¿ç”¨ã•ã‚Œã€ ä»–ã®ãƒ„ãƒ¼ãƒ«ãªã—ã« `bun test` ã§ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ã€‚

```ts
describe('Tests', () => {
    let client: TestClient;
    let mockDB: ReturnType<typeof createMockD1Database>;

    beforeEach(() => {
        mockDB = createMockD1Database();
        client = testClient(app, {
            DB: mockDB,
        });
    });

    test('api', async () => {
        const res = await client.api.items.$get();
        expect(res.status).toBe(200);

        const items = await res.json();
        expect(Array.isArray(items)).toBe(true);
        expect(items).toHaveLength(0);
    });
})
```

äº‹å‰ã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãªã‚“ã‹ãŒã»ã—ã„ã¨ãã¯æ™®é€šã« `mockDB.exec` ã‚’ä½¿ã£ã¦å…¥ã‚ŒãŸã‚Šã—ã¦ã„ã‚‹ã€‚

## Refs

- https://hono.dev/docs/helpers/testing
- https://github.com/yusukebe/testing-d1-app-with-types
- https://bun.com/docs/api/sqlite