---
layout: ../../layouts/blog-post.astro
title: "Claude Code ã‚’ GitHub Actions ã§å‹•ã‹ã™"
emoji: ğŸ–Š
date: 2025-04-20T21:34:01Z
tags:
    - note
---

Claude Code ã¯ `claude -p` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±ãªã—ã«ä¸€åº¦ã ã‘ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

- https://docs.anthropic.com/ja/docs/agents-and-tools/claude-code/overview#cli

ã“ã‚Œã‚’ `ANTHROPIC_API_KEY` ã‚’è¨­å®šã—ãŸç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ CI ã¨ã—ã¦å‹•ä½œã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚‹(ç›´è¿‘ã§ã“ã®éƒ¨åˆ†ã«ãƒã‚°ãŒã‚ã£ãŸãŒä¿®æ­£ã•ã‚ŒãŸ)ã€‚

- https://docs.anthropic.com/ja/docs/agents-and-tools/claude-code/overview#ci
- https://github.com/anthropics/claude-code/issues/551

ä»¥ä¸‹ã¯ GitHub Actions ã§ Issue ã«ãƒ©ãƒ™ãƒ«ã‚’ã¤ã‘ã‚‹ã¨è§£æ±ºã‚’è©¦ã¿ã¦ãã‚Œã‚‹ã‚µãƒ³ãƒ—ãƒ«:

```yaml
name: Claude Issue Solver

on:
    issues:
        types: [opened, edited, labeled]

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:
    analyze-issue:
        runs-on: ubuntu-latest
        # Only run when issues have the 'claude-solve' label
        if: contains(github.event.issue.labels.*.name, 'claude-solve')
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: Setup Git
              run: |
                  git config --global user.name "GitHub Action"
                  git config --global user.email "action@github.com"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x

            - name: Setup PNPM
              uses: pnpm/action-setup@v3

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Claude Code
              run: npm install -g @anthropic-ai/claude-code

            - name: Create new branch
              run: |
                  BRANCH_NAME="claude-fix-issue-${{ github.event.issue.number }}"
                  git checkout -b "$BRANCH_NAME"

            - name: Save issue details
              env:
                  ISSUE_TITLE: ${{ github.event.issue.title }}
                  ISSUE_BODY: ${{ github.event.issue.body }}
                  ISSUE_NUMBER: ${{ github.event.issue.number }}
              run: |
                  # Save issue details to file for Claude to analyze
                  cat > issue.txt << EOF
                  Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

                  ${ISSUE_BODY}
                  EOF
            - name: Evaluate issue solvability
              id: evaluate
              env:
                  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
              run: |
                  export ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
                  echo $ANTHROPIC_API_KEY
                  # Use Claude Code to evaluate if the issue can be solved
                  EVALUATION_JSON=$(cat issue.txt | claude -p "ã‚ãªãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€ã“ã®Issueã‚’è§£æ±ºã§ãã‚‹ã‹ã©ã†ã‹è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚ã“ã®Issueã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ååˆ†ãªæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€Œ[Yes]ã€ã¨è¿”ã—ã¦ãã ã•ã„ã€‚ãã†ã§ãªã„å ´åˆã¯ã€Œ[No]ã€ã¨è¿”ã—ã¦ã€ãã®æ¬¡ã®è¡Œã«ç†ç”±ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚" --json)
                  echo "EVALUATION_JSON: $EVALUATION_JSON"
                  # Extract cost information
                  COST_USD=$(echo "$EVALUATION_JSON" | jq -r '.cost_usd')
                  echo "è©•ä¾¡ã‚³ã‚¹ãƒˆ: $COST_USD USD"

                  # Extract the result
                  EVALUATION=$(echo "$EVALUATION_JSON" | jq -r '.result')

                  # Extract yes/no response and reason
                  if echo "$EVALUATION" | grep -q "\[Yes\]"; then
                    echo "solvable=true" >> $GITHUB_OUTPUT
                    echo "reason=Issueã«ã¯è§£æ±ºã™ã‚‹ãŸã‚ã®ååˆ†ãªæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚" >> $GITHUB_OUTPUT
                  else
                    echo "solvable=false" >> $GITHUB_OUTPUT
                    REASON=$(echo "$EVALUATION" | sed -n '/\[No\]/,/^$/p' | tail -n +2)
                    echo "reason<<EOF" >> $GITHUB_OUTPUT
                    echo "$REASON" >> $GITHUB_OUTPUT
                    echo "EOF" >> $GITHUB_OUTPUT
                  fi

                  # Save total cost for reporting
                  echo "cost_usd=$COST_USD" >> $GITHUB_OUTPUT
            - name: Comment on unsolvable issue
              if: steps.evaluate.outputs.solvable != 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.issue.number }}
                  COST_USD: ${{ steps.evaluate.outputs.cost_usd }}
              run: |
                  COMMENT="## Claude è©•ä¾¡çµæœ

                  ã“ã®Issueã¯è‡ªå‹•çš„ã«è§£æ±ºã§ãã¾ã›ã‚“ã€‚

                  **ç†ç”±:** ${{ steps.evaluate.outputs.reason }}

                  ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’æä¾›ã™ã‚‹ã‹ã€è¦ä»¶ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚

                  **ã‚³ã‚¹ãƒˆ:** ${COST_USD} USD"

                  gh issue comment "$ISSUE_NUMBER" --body "$COMMENT"

            - name: Solve issue
              if: steps.evaluate.outputs.solvable == 'true'
              id: solve
              env:
                  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
              run: |
                  # Use Claude Code to solve the issue
                  SOLUTION_JSON=$(cat issue.txt | claude -p "ã“ã®Issueã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«å¿…è¦ãªä½œæ¥­ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚" --json --allowedTools "Bash(git diff:*)" "Bash(git log:*)" Edit)

                  # Extract cost and result information
                  COST_USD=$(echo "$SOLUTION_JSON" | jq -r '.cost_usd')
                  RESULT=$(echo "$SOLUTION_JSON" | jq -r '.result')

                  echo "è§£æ±ºã‚³ã‚¹ãƒˆ: $COST_USD USD"
                  echo "è§£æ±ºçµæœ: $RESULT"

                  # Save for reporting
                  echo "cost_usd=$COST_USD" >> $GITHUB_OUTPUT
                  echo "result<<EOF" >> $GITHUB_OUTPUT
                  echo "$RESULT" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Apply auto-fixes
              if: steps.evaluate.outputs.solvable == 'true'
              run: |
                  pnpm format || true
                  pnpm lint:fix || true
            - name: Create PR
              if: steps.evaluate.outputs.solvable == 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.issue.number }}
                  ISSUE_TITLE: ${{ github.event.issue.title }}
                  SOLVE_COST: ${{ steps.solve.outputs.cost_usd }}
                  EVAL_COST: ${{ steps.evaluate.outputs.cost_usd }}
                  SOLVE_RESULT: ${{ steps.solve.outputs.result }}
              run: |
                  BRANCH_NAME="claude-fix-issue-${ISSUE_NUMBER}"

                  # Calculate total cost
                  TOTAL_COST=$(echo "$EVAL_COST + $SOLVE_COST" | bc)
                  rm issue.txt
                  git add .
                  git commit -m "Fix: Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
                  git push -u origin "$BRANCH_NAME"

                  PR_BODY="## Claude ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£

                  ã“ã®PRã¯Issue #${ISSUE_NUMBER} ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

                  **è§£æ±ºçµæœ:**
                  ${SOLVE_RESULT}

                  **Claude AI ã‚³ã‚¹ãƒˆ:** ${TOTAL_COST} USD

                  Claude AI ğŸ¤– ã«ã‚ˆã£ã¦å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ"

                  gh pr create --title "Fix: ${ISSUE_TITLE}" --body "$PR_BODY" --base main

                  gh issue comment "$ISSUE_NUMBER" --body "ä¿®æ­£ç”¨ã®PRã‚’ä½œæˆã—ã¾ã—ãŸï¼ ğŸ‰ ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚Claude AIã®ã‚³ã‚¹ãƒˆ: ${TOTAL_COST} USD"
```

Claude Code ã§ç·¨é›†ã—ãŸã‚ã¨ eslint ã¨ prettier ã‚’å®Ÿè¡Œã—ã¦ PR ã‚’ä½œã‚‰ã›ã¦ã„ã‚‹ã€æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ãŸã‚‰ Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒæ¥ã‚‹ã¯ãšã ãŒã€ã„ã¾ã®ã¨ã“ã‚ã‹ãªã‚Šé©å½“ãªå†…å®¹ã§ã‚‚è§£æ±ºã—ã‚ˆã†ã¨ã™ã‚‹ã€‚ ãƒ†ã‚¹ãƒˆã‚„ eslintã€prettier ã«å¤±æ•—ã—ãŸã‚‰ãã‚Œã‚’ã‚‚ã¨ã«æ›´ã«ä¿®æ­£ã•ã›ã‚‹ã“ã¨ã‚‚ã—ãŸã‹ã£ãŸãŒã€yaml ã¨ã—ã¦æ›¸ãã®ãŒé¢å€’ã§ä»Šå›ã¯ãã“ã¾ã§ã¯ã‚„ã£ã¦ã„ãªã„ã€‚

Roo Mode ã®ã‚ˆã†ãªå½¹å‰²ã‚’ä¸ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆ¥é€”ç”¨æ„ã—ã¦ãŠãã¨ç²¾åº¦ãŒã‚ˆããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚